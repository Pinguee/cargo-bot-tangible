<!DOCTYPE html>
<html>
<head>
  <title>Cargo Tangible</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <header>
    <h1 id="title" onclick="window.location.href = 'index.html';">Cargo Tangible</h1>
  </header>

  <div id="modal" class="modal">
    <div id="scanner">
      <canvas id="video-canvas" width="1280" height="720"></canvas>
      <div id="buttonContainer">
        <button id="scanButton" class="scannerButton"></button>
        <button id="closeButton" class="scannerButton"></button>
      </div>
    </div>
  </div>


  <div id="modalImg" class="modal">
    <div id="scannerImg" class="scanner">
      <canvas id="image-canvas" width="1280" height="720"></canvas>
      <div id="buttonContainerImg" class="buttonContainer">
        <button id="scanButtonImg" class="scannerButton"></button>
        <button id="closeButtonImg" class="scannerButton"></button>
      </div>
    </div>
  </div>

  <div id="modalQr" class="modal">
    <p id="qrcodeText">Scannez ce QRCode pour vous connecter à cette page via votre smartphone et ainsi pouvoir transmettre les photos des programmes facilement.</p>
    <div id="qrcode"></div>
    <div id="buttonContainerQr">
      <button id="closeButtonQr" class="scannerButton"></button>
    </div>
  </div>

  <div id="main">
    <div id="inputMethod">
      <button id="camInButton" class="button"></button>
      <label>
				<input type="file" accept="image/*" id="fileInput" capture="camera">
			  <div id="imgInButton" class="button"></div>
			</label>
      <button id="phoneInButton" class="button"></button>
    </div>

    <div id="selectorCam" class="select" style="display: none;">
      <select id="videoSource">
        <option value="" selected disabled hidden>Sélectionnez la caméra</option>
      </select>
      <div id="buttonContainerSelect">
        <button id="closeButtonSelect" class="scannerButton"></button>
      </div>
    </div>

    <iframe id="frame" src="cargo-not/index.html" width="1000" height="1400"></iframe> 
  </div>

  <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
  <script src="connect/peerjs.min.js"></script>
  <script src="TopCodes/js/adapter-0.2.9.js"></script>
  <script src="TopCodes/js/topcodes.js"></script>
  <script defer src="TopCodes/dart/main.dart.js"></script>
  <script src="stylescript.js"></script>
  <script src="perspective-transform.js"></script>
  <script src="test_script_rotation.js"></script>

  <script>
    // register a callback function with the TopCode library
    TopCodes.setVideoFrameCallback("video-canvas", function (jsonString) {

    // convert the JSON string to an object
    var json = JSON.parse(jsonString);

    // get the list of topcodes from the JSON object
    topcodes = json.topcodes;

    for (i = 0; i < topcodes.length; i++) { 
      if (topcodes[i].code >= 103 && topcodes[i].code <= 143) {
        var image = new Image();
        image.src = "img/instruction/" + topcodes[i].code.toString() +".svg";
        ctx.translate(topcodes[i].x, topcodes[i].y);
        // ctx.rotate(topcodes[i].radius);
        ctx.drawImage(image, -topcodes[i].radius*1.5, -topcodes[i].radius*1.5, topcodes[i].radius * 3, topcodes[i].radius * 3);
        // ctx.rotate(-topcodes[i].radius);
        ctx.translate(-topcodes[i].x, -topcodes[i].y);
      }
      if (topcodes[i].code >= 157 && topcodes[i].code <= 181) {
        var image = new Image();
        image.src = "img/instruction/" + topcodes[i].code.toString() +".svg";
        ctx.translate(topcodes[i].x, topcodes[i].y);
        // ctx.rotate(topcodes[i].radius);
        ctx.drawImage(image, -topcodes[i].radius*3, -topcodes[i].radius*1.5, topcodes[i].radius * 4.5, topcodes[i].radius * 2.25);
        // ctx.rotate(-topcodes[i].radius);
        ctx.translate(-topcodes[i].x, -topcodes[i].y);
      } 
    }

    document.getElementById("scanButton").onclick = function(){
      scan(json.topcodes, true);  
      TopCodes.stopVideoScan('video-canvas');
      document.getElementById("modal").style.display = "none";
    }
    });

    var canvas = document.querySelector("#video-canvas");
    var ctx = canvas.getContext('2d');
  </script>

</body>
</html>